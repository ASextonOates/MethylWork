# Estimate cell counts using minfi
# Requires rgset

# Libraries
library(minfi)
# As required
library(FlowSorted.Blood.450k)
library(FlowSorted.DLPFC.450k)
library(FlowSorted.CordBlood.450k)

# Blood
counts = estimateCellCounts(rgset, compositeCellType='Blood', meanPlot = FALSE, cellTypes = c("CD8T","CD4T", "NK","Bcell","Mono","Eos","Neu"), returnAll=TRUE, quantileNormalize = TRUE, stratified = TRUE)

# Cord blood
counts = estimateCellCounts(rgset, compositeCellType='CordBlood', meanPlot = FALSE, cellTypes = c("Bcell", "CD4T", "CD8T", "Gran", "Mono", "NK", "nRBC"), returnAll=TRUE, quantileNormalize = TRUE, stratified = TRUE)

# DLPFC
counts = estimateCellCounts(rgset, compositeCellType='DLPFC', meanPlot = FALSE, cellTypes = c("NeuN_neg", "NeuN_pos"), returnAll=TRUE, quantileNormalize = TRUE, stratified = TRUE)

# Make table of cell counts for each samples
cellcounts = round(as.matrix(counts$counts),2)

# Write table
write.table(cellcounts, file="Cell Counts.csv",sep=",", col.names=NA)
